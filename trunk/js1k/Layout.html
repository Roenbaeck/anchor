<!DOCTYPE HTML>
<html>
	<head>
		<title>JS1k Demo - 1024 bytes</title>
		<meta charset="utf-8"/>
	</head>
	<body>
		<canvas id="c"></canvas>
		<script>
        F=.95;      // 5% friction
        D=40;       // derived as (W+H)/30
        K=2e-5;     // derived as 1/D/D/D
        T=255;      // max color value
        N=[0];      // nodes, zeroth position is a dummy
        M=[0];      // edges, zeroth position is a dummy
        n=I=0;      // n=last node index, I=index of selected node
        A=Math.abs;
        P=2*Math.PI;
        C=document.body.children[0];
        C.width=C.height=W=H=X=Y=600;
        onkeydown=function(e){
            // add a node
            N[i=++n]={x:X,y:Y,v:0,w:0,m:1};
            // add edges to selected nodes
            for(j=n;k=N[j];j--)
                if(!k.m&&!M[j]){
                    N[++n]={x:(X-k.x)/2,y:(Y-k.y)/2,v:0,w:0,m:1};
                    M[n]=[i,j]
                }
        };
        C.onmousedown=function(e){
            // the blue part of the pixel encodes the node index
            I=G.getImageData(X,Y,1,1).data[2];
            // toggle moving/fixed state
            if(k=N[I=M[I]?0:I]){
                k.m=!k.m;
                k.v=k.w=0
            }
        };
        C.onmousemove=function(e){
            X=e.clientX;
            Y=e.clientY;
            // if we are dragging a node, update its coordinates
            if(k=N[I]){
                    k.x=X;
                    k.y=Y;
                    k.m=0
            }
        };
        C.onmouseup=function(){
            I=0
        };
        G=C.getContext('2d');
        setInterval(function(){
            with(G){
                clearRect(0,0,W,H);
                strokeRect(0,0,W,H);
                // loop over all nodes
                for(i=n;k=N[i];i--)
                    with(k){
                        if(m&&i!=I){
                            // calculate the repelling forces from nearby nodes
                            for(j=n;o=N[j];j--)
                                if((t=A(x-o.x)+A(y-o.y))<2*D&&i!=j){
                                    t*=t;
                                    v+=(x-o.x)/t;
                                    w+=(y-o.y)/t
                                }
                            // apply attracting forces to connected nodes if this is an edge
                            if(M[i])
                                for(j=0;o=N[M[i][j]];j++){
                                    t=A(x-o.x)+A(y-o.y);
                                    v-=r=K*(x-o.x)*t;
                                    w-=s=K*(y-o.y)*t;
                                    o.v+=r;
                                    o.w+=s
                                }
                            // apply friction and update coordinates
                            x+=v*=F;
                            y+=w*=F;
                            // do not cross borders of the canvas
                            x=x>W?W:x<0?0:x;
                            y=y>H?H:y<0?0:y;
                        }
                        // draw the edge or node on the canvas
                        beginPath();
                        if(M[i]){
                            o=N[M[i][0]];
                            p=N[M[i][1]];
                            moveTo(o.x,o.y);
                            quadraticCurveTo(x,y,p.x,p.y)
                        }else{
                            arc(x,y,D/3,0,P,0);
                            fillStyle='rgb('+!m*T+','+m*T+','+i+')';
                            fill()
                        }
                        stroke()
                    }
            }
        },1);
        </script>
        <br/>
        Hover over the canvas and press any key to add a node.
        <br/>
        Click to select/fixate a node.
        <br/>
        Click again to unselect/release a node.
        <br/>
        Selected nodes will be connected to the added node.
	</body>
</html>